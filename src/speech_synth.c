#include "speech_synth.h"

#include <stddef.h>
#include <stdbool.h>

#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/sleep.h>

#include <util/atomic.h>

#include "speech_data.h"

#define SAMPLE_TO_PWM(_s) ((_s + (32767 / 2)) / (8))

struct _speech_synth_t
{
    fix16_t *g_addr;
    uint8_t *ps_addr;
    fix16_t *a_addr;
    uint16_t len;
    uint16_t frame_idx;

    uint16_t t;
    uint8_t ps;
    fix16_t g;
    uint16_t xs_idx;
    fix16_t xs[LPC_ORDER];
    fix16_t hs[LPC_ORDER];
};

// clang-format off
const fix16_t RND[256] PROGMEM = {
    494, 724, -351, 36, 87, 438, -35, 210, 389, 1017, -246, 803, 192, 329, -297, -364,
    -201, 707, -712, -938, -744, -944, 129, 1021, -998, 695, 798, 130, 514, -202, -341, -969,
    381, -295, 101, 809, -244, -46, -81, -149, 354, -232, 219, 735, 778, -532, 301, 0,
    503, -128, 244, 685, -245, -299, 6, -922, 956, -625, -383, 469, -935, -600, 704, -492,
    804, -346, 801, -802, 750, 644, 307, -362, -137, 949, 677, -851, 718, -1009, 172, -1017,
    472, -451, 4, 877, -639, 337, -335, -299, -684, 319, 391, -833, -405, 601, -126, 718,
    -860, -963, -988, -650, -309, -431, 116, 5, -769, -397, -427, -533, -346, -136, -644, 831,
    635, 75, -492, -779, 697, 270, -871, 1022, 232, -161, -1006, -808, -372, -301, 456, 1021,
    -50, -685, 628, 540, 235, -61, -747, -369, -998, 673, -676, 519, 369, 785, -332, 739,
    -505, 504, -113, -766, -96, 678, 37, 103, -786, 524, 920, 701, 297, 387, -318, -115,
    -92, 681, -732, 522, -626, -447, -610, -752, -641, -811, 967, -252, 342, -958, 992, 225,
    -859, -433, 346, 20, -932, -551, -51, 531, -500, -849, 491, -397, -276, 315, 500, -96,
    -98, -946, 838, 436, -751, -736, -558, 239, -430, -171, -412, 655, -705, 376, -574, 308,
    708, -772, 606, 951, -17, -1, 29, 575, -732, -831, 817, -703, 265, 927, -676, 708,
    -584, -339, -143, 10, -223, -224, -285, -669, 78, -998, -87, 743, 145, -825, 42, 930,
    -714, 52, -308, -841, 481, -382, 51, -127, 190, 65, 80, 147, 63, 59, -392, 871
};

static const fix16_t sine_tab[1024] PROGMEM = {
    0x0000, 0x0006, 0x000D, 0x0013, 0x0019, 0x001F, 0x0026, 0x002C, 0x0032, 0x0039, 0x003F, 0x0045, 0x004B, 0x0052, 0x0058, 0x005E,
    0x0064, 0x006B, 0x0071, 0x0077, 0x007D, 0x0084, 0x008A, 0x0090, 0x0096, 0x009C, 0x00A3, 0x00A9, 0x00AF, 0x00B5, 0x00BB, 0x00C2,
    0x00C8, 0x00CE, 0x00D4, 0x00DA, 0x00E0, 0x00E6, 0x00ED, 0x00F3, 0x00F9, 0x00FF, 0x0105, 0x010B, 0x0111, 0x0117, 0x011D, 0x0123,
    0x0129, 0x012F, 0x0135, 0x013B, 0x0141, 0x0147, 0x014D, 0x0153, 0x0159, 0x015F, 0x0165, 0x016B, 0x0171, 0x0176, 0x017C, 0x0182,
    0x0188, 0x018E, 0x0193, 0x0199, 0x019F, 0x01A5, 0x01AA, 0x01B0, 0x01B6, 0x01BB, 0x01C1, 0x01C7, 0x01CC, 0x01D2, 0x01D8, 0x01DD,
    0x01E3, 0x01E8, 0x01EE, 0x01F3, 0x01F9, 0x01FE, 0x0204, 0x0209, 0x020E, 0x0214, 0x0219, 0x021F, 0x0224, 0x0229, 0x022E, 0x0234,
    0x0239, 0x023E, 0x0243, 0x0248, 0x024E, 0x0253, 0x0258, 0x025D, 0x0262, 0x0267, 0x026C, 0x0271, 0x0276, 0x027B, 0x0280, 0x0285,
    0x028A, 0x028E, 0x0293, 0x0298, 0x029D, 0x02A2, 0x02A6, 0x02AB, 0x02B0, 0x02B4, 0x02B9, 0x02BE, 0x02C2, 0x02C7, 0x02CB, 0x02D0,
    0x02D4, 0x02D9, 0x02DD, 0x02E1, 0x02E6, 0x02EA, 0x02EE, 0x02F3, 0x02F7, 0x02FB, 0x02FF, 0x0303, 0x0307, 0x030B, 0x0310, 0x0314,
    0x0318, 0x031C, 0x031F, 0x0323, 0x0327, 0x032B, 0x032F, 0x0333, 0x0336, 0x033A, 0x033E, 0x0342, 0x0345, 0x0349, 0x034C, 0x0350,
    0x0353, 0x0357, 0x035A, 0x035E, 0x0361, 0x0364, 0x0368, 0x036B, 0x036E, 0x0372, 0x0375, 0x0378, 0x037B, 0x037E, 0x0381, 0x0384,
    0x0387, 0x038A, 0x038D, 0x0390, 0x0393, 0x0395, 0x0398, 0x039B, 0x039E, 0x03A0, 0x03A3, 0x03A6, 0x03A8, 0x03AB, 0x03AD, 0x03B0,
    0x03B2, 0x03B4, 0x03B7, 0x03B9, 0x03BB, 0x03BE, 0x03C0, 0x03C2, 0x03C4, 0x03C6, 0x03C8, 0x03CA, 0x03CC, 0x03CE, 0x03D0, 0x03D2,
    0x03D4, 0x03D6, 0x03D7, 0x03D9, 0x03DB, 0x03DD, 0x03DE, 0x03E0, 0x03E1, 0x03E3, 0x03E4, 0x03E6, 0x03E7, 0x03E8, 0x03EA, 0x03EB,
    0x03EC, 0x03EE, 0x03EF, 0x03F0, 0x03F1, 0x03F2, 0x03F3, 0x03F4, 0x03F5, 0x03F6, 0x03F7, 0x03F8, 0x03F8, 0x03F9, 0x03FA, 0x03FA,
    0x03FB, 0x03FC, 0x03FC, 0x03FD, 0x03FD, 0x03FE, 0x03FE, 0x03FE, 0x03FF, 0x03FF, 0x03FF, 0x0400, 0x0400, 0x0400, 0x0400, 0x0400,
    0x0400, 0x0400, 0x0400, 0x0400, 0x0400, 0x0400, 0x03FF, 0x03FF, 0x03FF, 0x03FE, 0x03FE, 0x03FE, 0x03FD, 0x03FD, 0x03FC, 0x03FC,
    0x03FB, 0x03FA, 0x03FA, 0x03F9, 0x03F8, 0x03F8, 0x03F7, 0x03F6, 0x03F5, 0x03F4, 0x03F3, 0x03F2, 0x03F1, 0x03F0, 0x03EF, 0x03EE,
    0x03EC, 0x03EB, 0x03EA, 0x03E8, 0x03E7, 0x03E6, 0x03E4, 0x03E3, 0x03E1, 0x03E0, 0x03DE, 0x03DD, 0x03DB, 0x03D9, 0x03D7, 0x03D6,
    0x03D4, 0x03D2, 0x03D0, 0x03CE, 0x03CC, 0x03CA, 0x03C8, 0x03C6, 0x03C4, 0x03C2, 0x03C0, 0x03BE, 0x03BB, 0x03B9, 0x03B7, 0x03B4,
    0x03B2, 0x03B0, 0x03AD, 0x03AB, 0x03A8, 0x03A6, 0x03A3, 0x03A0, 0x039E, 0x039B, 0x0398, 0x0395, 0x0393, 0x0390, 0x038D, 0x038A,
    0x0387, 0x0384, 0x0381, 0x037E, 0x037B, 0x0378, 0x0375, 0x0372, 0x036E, 0x036B, 0x0368, 0x0364, 0x0361, 0x035E, 0x035A, 0x0357,
    0x0353, 0x0350, 0x034C, 0x0349, 0x0345, 0x0342, 0x033E, 0x033A, 0x0336, 0x0333, 0x032F, 0x032B, 0x0327, 0x0323, 0x031F, 0x031C,
    0x0318, 0x0314, 0x0310, 0x030B, 0x0307, 0x0303, 0x02FF, 0x02FB, 0x02F7, 0x02F3, 0x02EE, 0x02EA, 0x02E6, 0x02E1, 0x02DD, 0x02D9,
    0x02D4, 0x02D0, 0x02CB, 0x02C7, 0x02C2, 0x02BE, 0x02B9, 0x02B4, 0x02B0, 0x02AB, 0x02A6, 0x02A2, 0x029D, 0x0298, 0x0293, 0x028E,
    0x028A, 0x0285, 0x0280, 0x027B, 0x0276, 0x0271, 0x026C, 0x0267, 0x0262, 0x025D, 0x0258, 0x0253, 0x024E, 0x0248, 0x0243, 0x023E,
    0x0239, 0x0234, 0x022E, 0x0229, 0x0224, 0x021F, 0x0219, 0x0214, 0x020E, 0x0209, 0x0204, 0x01FE, 0x01F9, 0x01F3, 0x01EE, 0x01E8,
    0x01E3, 0x01DD, 0x01D8, 0x01D2, 0x01CC, 0x01C7, 0x01C1, 0x01BB, 0x01B6, 0x01B0, 0x01AA, 0x01A5, 0x019F, 0x0199, 0x0193, 0x018E,
    0x0188, 0x0182, 0x017C, 0x0176, 0x0171, 0x016B, 0x0165, 0x015F, 0x0159, 0x0153, 0x014D, 0x0147, 0x0141, 0x013B, 0x0135, 0x012F,
    0x0129, 0x0123, 0x011D, 0x0117, 0x0111, 0x010B, 0x0105, 0x00FF, 0x00F9, 0x00F3, 0x00ED, 0x00E6, 0x00E0, 0x00DA, 0x00D4, 0x00CE,
    0x00C8, 0x00C2, 0x00BB, 0x00B5, 0x00AF, 0x00A9, 0x00A3, 0x009C, 0x0096, 0x0090, 0x008A, 0x0084, 0x007D, 0x0077, 0x0071, 0x006B,
    0x0064, 0x005E, 0x0058, 0x0052, 0x004B, 0x0045, 0x003F, 0x0039, 0x0032, 0x002C, 0x0026, 0x001F, 0x0019, 0x0013, 0x000D, 0x0006,
    0x0000, -0x006, -0x00D, -0x013, -0x019, -0x01F, -0x026, -0x02C, -0x032, -0x039, -0x03F, -0x045, -0x04B, -0x052, -0x058, -0x05E,
    -0x064, -0x06B, -0x071, -0x077, -0x07D, -0x084, -0x08A, -0x090, -0x096, -0x09C, -0x0A3, -0x0A9, -0x0AF, -0x0B5, -0x0BB, -0x0C2,
    -0x0C8, -0x0CE, -0x0D4, -0x0DA, -0x0E0, -0x0E6, -0x0ED, -0x0F3, -0x0F9, -0x0FF, -0x105, -0x10B, -0x111, -0x117, -0x11D, -0x123,
    -0x129, -0x12F, -0x135, -0x13B, -0x141, -0x147, -0x14D, -0x153, -0x159, -0x15F, -0x165, -0x16B, -0x171, -0x176, -0x17C, -0x182,
    -0x188, -0x18E, -0x193, -0x199, -0x19F, -0x1A5, -0x1AA, -0x1B0, -0x1B6, -0x1BB, -0x1C1, -0x1C7, -0x1CC, -0x1D2, -0x1D8, -0x1DD,
    -0x1E3, -0x1E8, -0x1EE, -0x1F3, -0x1F9, -0x1FE, -0x204, -0x209, -0x20E, -0x214, -0x219, -0x21F, -0x224, -0x229, -0x22E, -0x234,
    -0x239, -0x23E, -0x243, -0x248, -0x24E, -0x253, -0x258, -0x25D, -0x262, -0x267, -0x26C, -0x271, -0x276, -0x27B, -0x280, -0x285,
    -0x28A, -0x28E, -0x293, -0x298, -0x29D, -0x2A2, -0x2A6, -0x2AB, -0x2B0, -0x2B4, -0x2B9, -0x2BE, -0x2C2, -0x2C7, -0x2CB, -0x2D0,
    -0x2D4, -0x2D9, -0x2DD, -0x2E1, -0x2E6, -0x2EA, -0x2EE, -0x2F3, -0x2F7, -0x2FB, -0x2FF, -0x303, -0x307, -0x30B, -0x310, -0x314,
    -0x318, -0x31C, -0x31F, -0x323, -0x327, -0x32B, -0x32F, -0x333, -0x336, -0x33A, -0x33E, -0x342, -0x345, -0x349, -0x34C, -0x350,
    -0x353, -0x357, -0x35A, -0x35E, -0x361, -0x364, -0x368, -0x36B, -0x36E, -0x372, -0x375, -0x378, -0x37B, -0x37E, -0x381, -0x384,
    -0x387, -0x38A, -0x38D, -0x390, -0x393, -0x395, -0x398, -0x39B, -0x39E, -0x3A0, -0x3A3, -0x3A6, -0x3A8, -0x3AB, -0x3AD, -0x3B0,
    -0x3B2, -0x3B4, -0x3B7, -0x3B9, -0x3BB, -0x3BE, -0x3C0, -0x3C2, -0x3C4, -0x3C6, -0x3C8, -0x3CA, -0x3CC, -0x3CE, -0x3D0, -0x3D2,
    -0x3D4, -0x3D6, -0x3D7, -0x3D9, -0x3DB, -0x3DD, -0x3DE, -0x3E0, -0x3E1, -0x3E3, -0x3E4, -0x3E6, -0x3E7, -0x3E8, -0x3EA, -0x3EB,
    -0x3EC, -0x3EE, -0x3EF, -0x3F0, -0x3F1, -0x3F2, -0x3F3, -0x3F4, -0x3F5, -0x3F6, -0x3F7, -0x3F8, -0x3F8, -0x3F9, -0x3FA, -0x3FA,
    -0x3FB, -0x3FC, -0x3FC, -0x3FD, -0x3FD, -0x3FE, -0x3FE, -0x3FE, -0x3FF, -0x3FF, -0x3FF, -0x400, -0x400, -0x400, -0x400, -0x400,
    -0x400, -0x400, -0x400, -0x400, -0x400, -0x400, -0x3FF, -0x3FF, -0x3FF, -0x3FE, -0x3FE, -0x3FE, -0x3FD, -0x3FD, -0x3FC, -0x3FC,
    -0x3FB, -0x3FA, -0x3FA, -0x3F9, -0x3F8, -0x3F8, -0x3F7, -0x3F6, -0x3F5, -0x3F4, -0x3F3, -0x3F2, -0x3F1, -0x3F0, -0x3EF, -0x3EE,
    -0x3EC, -0x3EB, -0x3EA, -0x3E8, -0x3E7, -0x3E6, -0x3E4, -0x3E3, -0x3E1, -0x3E0, -0x3DE, -0x3DD, -0x3DB, -0x3D9, -0x3D7, -0x3D6,
    -0x3D4, -0x3D2, -0x3D0, -0x3CE, -0x3CC, -0x3CA, -0x3C8, -0x3C6, -0x3C4, -0x3C2, -0x3C0, -0x3BE, -0x3BB, -0x3B9, -0x3B7, -0x3B4,
    -0x3B2, -0x3B0, -0x3AD, -0x3AB, -0x3A8, -0x3A6, -0x3A3, -0x3A0, -0x39E, -0x39B, -0x398, -0x395, -0x393, -0x390, -0x38D, -0x38A,
    -0x387, -0x384, -0x381, -0x37E, -0x37B, -0x378, -0x375, -0x372, -0x36E, -0x36B, -0x368, -0x364, -0x361, -0x35E, -0x35A, -0x357,
    -0x353, -0x350, -0x34C, -0x349, -0x345, -0x342, -0x33E, -0x33A, -0x336, -0x333, -0x32F, -0x32B, -0x327, -0x323, -0x31F, -0x31C,
    -0x318, -0x314, -0x310, -0x30B, -0x307, -0x303, -0x2FF, -0x2FB, -0x2F7, -0x2F3, -0x2EE, -0x2EA, -0x2E6, -0x2E1, -0x2DD, -0x2D9,
    -0x2D4, -0x2D0, -0x2CB, -0x2C7, -0x2C2, -0x2BE, -0x2B9, -0x2B4, -0x2B0, -0x2AB, -0x2A6, -0x2A2, -0x29D, -0x298, -0x293, -0x28E,
    -0x28A, -0x285, -0x280, -0x27B, -0x276, -0x271, -0x26C, -0x267, -0x262, -0x25D, -0x258, -0x253, -0x24E, -0x248, -0x243, -0x23E,
    -0x239, -0x234, -0x22E, -0x229, -0x224, -0x21F, -0x219, -0x214, -0x20E, -0x209, -0x204, -0x1FE, -0x1F9, -0x1F3, -0x1EE, -0x1E8,
    -0x1E3, -0x1DD, -0x1D8, -0x1D2, -0x1CC, -0x1C7, -0x1C1, -0x1BB, -0x1B6, -0x1B0, -0x1AA, -0x1A5, -0x19F, -0x199, -0x193, -0x18E,
    -0x188, -0x182, -0x17C, -0x176, -0x171, -0x16B, -0x165, -0x15F, -0x159, -0x153, -0x14D, -0x147, -0x141, -0x13B, -0x135, -0x12F,
    -0x129, -0x123, -0x11D, -0x117, -0x111, -0x10B, -0x105, -0x0FF, -0x0F9, -0x0F3, -0x0ED, -0x0E6, -0x0E0, -0x0DA, -0x0D4, -0x0CE,
    -0x0C8, -0x0C2, -0x0BB, -0x0B5, -0x0AF, -0x0A9, -0x0A3, -0x09C, -0x096, -0x090, -0x08A, -0x084, -0x07D, -0x077, -0x071, -0x06B,
    -0x064, -0x05E, -0x058, -0x052, -0x04B, -0x045, -0x03F, -0x039, -0x032, -0x02C, -0x026, -0x01F, -0x019, -0x013, -0x00D, -0x006};

// clang-format on

static volatile bool g_finished = false;
static volatile uint8_t buf_idx = 0;
static uint16_t samp_buf[2][LPC_FRAME_LEN];

ISR(TCA0_OVF_vect)
{
    static uint16_t idx = 0;
    static uint16_t p = 0;
    static uint16_t sample = 0;
    static uint16_t err = 0;

    if (p == 0)
    {
        sample = samp_buf[buf_idx][idx++];
        err = sample % 4;
        sample /= 4;
        TCA0.SINGLE.CMP0 = sample;
    }

    switch (err)
    {
    case 0:
        TCA0.SINGLE.CMP0 = sample;
        break;

    case 1:
        TCA0.SINGLE.CMP0 = sample + (p % 2);
        break;

    case 2:
        TCA0.SINGLE.CMP0 = sample + (p > 0);
        break;

    case 3:
        TCA0.SINGLE.CMP0 = sample + 1;
        break;
    }

    if (idx == LPC_FRAME_LEN)
    {
        idx = 0;
        g_finished = true;
    }

    p = (p + 1) % 4;
    TCA0.SINGLE.INTFLAGS = TCA_SINGLE_OVF_bm;
}

static void update(speech_synth_t *self)
{
    self->xs_idx = 0;
    self->g = i16_to_fix(pgm_read_word(&self->g_addr[self->frame_idx]));
    self->ps = pgm_read_byte(&self->ps_addr[self->frame_idx]);

    for (uint8_t j = 0; j < LPC_ORDER; j++)
    {
        self->hs[j] = i16_to_fix(pgm_read_word(&self->a_addr[(self->frame_idx * LPC_ORDER) + j]));
        self->xs[j] = FIX_ZERO;
    }
    self->frame_idx++;
}

static void exec(speech_synth_t *self, uint16_t *y)
{
    static uint16_t rnd_idx = 0;
    static size_t last_p = 0;
    static fix16_t de_y_ = 0;
    int32_t x;

    for (uint16_t i = 0; i < LPC_FRAME_LEN; i++)
    {
        fix16_t noise = pgm_read_word(&RND[rnd_idx]);
        rnd_idx = (rnd_idx + 1) % 256;

        if (self->ps < 0x15)
        {
            x = fix_mul(self->g, noise);
        }
        else
        {
            if ((self->t - last_p) >= (self->ps))
            {
                last_p = self->t;
                x = 4 * self->g;
            }
            else
            {
                x = 0;
            }
        }

        for (uint16_t k = 0; k < LPC_ORDER; k++)
        {
            x += fix_mul(self->hs[k], self->xs[k]);
        }

        fix16_t de_y = x + fix_mul(LPC_DEEMPHASIS_FACTOR, de_y_);
        de_y_ = de_y;

        for (uint16_t i = LPC_ORDER - 1; i > 0; i--)
        {
            self->xs[i] = self->xs[i - 1];
        }

        self->xs[0] = x;
        self->xs_idx = (self->xs_idx + 1) % LPC_ORDER;
        y[i] = SAMPLE_TO_PWM(de_y);
        self->t++;
    }
}

speech_synth_t *speech_synth_init(void)
{
    static speech_synth_t mem[1];
    static uint16_t mem_idx = 0;

    if (mem_idx > 0)
    {
        return NULL;
    }

    speech_synth_t *self = &mem[mem_idx++];

    PORTB.OUTCLR = SPEECH_SYNTH_PWM_PIN;

    {
        // make sure to update this after changing SPEECH_SYNTH_PWM_PIN
        PORTMUX.TCAROUTEA = PORTMUX_TCA00_bm;
        TCA0.SINGLE.CTRLB = TCA_SINGLE_WGMODE_SINGLESLOPE_gc | TCA_SINGLE_CMP0EN_bm;
        TCA0.SINGLE.EVCTRL &= ~(TCA_SINGLE_CNTAEI_bm);
        TCA0.SINGLE.PER = 625 - 1; // 16kHz
        TCA0.SINGLE.CMP0 = 0;
    }

    // Turn on timer
    TCA0.SINGLE.CTRLA = TCA_SINGLE_CLKSEL_DIV1_gc | TCA_SINGLE_ENABLE_bm | TCA_SINGLE_RUNSTDBY_bm;
    return self;
}

void speech_synth_say(speech_synth_t *self, lpc_name_e phrase_id)
{
    bool finished = false;

    if (phrase_id >= lpc_name_max)
    {
        return;
    }

    PORTB.DIRSET = SPEECH_SYNTH_PWM_PIN;
    self->t = 0;
    self->frame_idx = 0;
    self->g_addr = (fix16_t *)pgm_read_word(&LPC_G_ADDRS[phrase_id]);
    self->ps_addr = (uint8_t *)pgm_read_word(&LPC_PS_ADDRS[phrase_id]);
    self->a_addr = (fix16_t *)pgm_read_word(&LPC_A_ADDRS[phrase_id]);
    self->len = pgm_read_word(&LPC_LENGTHS[phrase_id]);

    update(self);
    exec(self, samp_buf[buf_idx]);

    TCA0.SINGLE.INTCTRL = TCA_SINGLE_OVF_bm;
    for (;;)
    {
        update(self);
        if (self->frame_idx == self->len)
        {
            break;
        }

        exec(self, samp_buf[buf_idx ^ 1]);

        do
        {
            sleep_mode();
            ATOMIC_BLOCK(ATOMIC_FORCEON)
            {
                finished = g_finished;
                g_finished = false;
            }
        } while (!finished);
        buf_idx ^= 1;
    }

    TCA0.SINGLE.INTCTRL = 0;
    PORTB.DIRCLR = SPEECH_SYNTH_PWM_PIN;
}

void speech_synth_tone(speech_synth_t *self)
{
    uint16_t freqs[2] = {1200, 1000};
    uint8_t f_idx = 0;
    uint16_t phase = 0;
    bool finished = false;

    PORTB.DIRSET = SPEECH_SYNTH_PWM_PIN;
    uint16_t *y = samp_buf[buf_idx];
    for (uint16_t i = 0; i < LPC_FRAME_LEN; i++)
    {
        const fix16_t v = pgm_read_word(&sine_tab[phase >> 6]);
        y[i] =  SAMPLE_TO_PWM(v);
        phase += freqs[f_idx] * 8;
    }

    TCA0.SINGLE.INTCTRL = TCA_SINGLE_OVF_bm;
    for (uint16_t i = 0; i < 20; i++)
    {
        if (i == 10)
        {
            f_idx = (f_idx + 1) % 2;
        }

        y = samp_buf[buf_idx ^ 1];
        for (uint16_t i = 0; i < LPC_FRAME_LEN; i++)
        {
            const fix16_t v = pgm_read_word(&sine_tab[phase >> 6]);
            y[i] = SAMPLE_TO_PWM(v);
            phase += freqs[f_idx] * 8;
        }

        do
        {
            sleep_mode();
            ATOMIC_BLOCK(ATOMIC_FORCEON)
            {
                finished = g_finished;
                g_finished = false;
            }
        } while (!finished);
        buf_idx ^= 1;
    }
    TCA0.SINGLE.INTCTRL = 0;
    PORTB.DIRCLR = SPEECH_SYNTH_PWM_PIN;
}